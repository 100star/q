(function(m,c){typeof define==="function"?define(function(c,j){m(c,j)}):typeof exports==="object"?m(require,exports):m(c,Q={})})(function(m,c,e){function j(a){return a}function o(){var a=[],b,d=p(g.prototype);d.promiseSend=function(){var d=Array.prototype.slice.call(arguments);a?a.push(d):q.apply(e,[b].concat(d))};d.valueOf=function(){if(a)return d;return k(b)};var c=function(d){var c;if(a){b=l(d);d=0;for(c=a.length;d<c;++d)q.apply(e,[b].concat(a[d]));a=e;return b}};return{promise:s(d),resolve:c,
reject:function(a){return c(f(a))}}}function g(a,b,d){b===e&&(b=function(a){return f("Promise does not support operation: "+a)});var c=p(g.prototype);c.promiseSend=function(d,c){var e=Array.prototype.slice.call(arguments,2),e=a[d]?a[d].apply(a,e):b.apply(a,[d].concat(e)),c=c||j;return c(e)};if(d)c.valueOf=d;return s(c)}function r(a){return a&&typeof a.promiseSend==="function"}function w(a){return!r(k(a))&&!t(a)}function t(a){a=k(a);if(a===e||a===null)return!1;return!!a.promiseRejected}function f(a){return g({when:function(b){return b?
b(a):f(a)}},function(){return f(a)},function(){var b=p(f.prototype);b.promiseRejected=!0;b.reason=a;return b})}function l(a){if(r(a))return a;if(a&&typeof a.then==="function")return g({},function(b){return b!=="when"?h(a,function(a){return l(a).promiseSend.apply(null,arguments)}):(b=o(),a.then(b.resolve,b.reject),b.promise)});return g({when:function(){return a},get:function(b){if(a===e||a===null)return f("Cannot access property "+b+" of "+a);return a[b]},put:function(b,d){if(a===e||a===null)return f("Cannot set property "+
b+" of "+a+" to "+d);return a[b]=d},del:function(b){if(a===e||a===null)return f("Cannot delete property "+b+" of "+a);return delete a[b]},post:function(b,d){if(a===e||a===null)return f(""+a+" has no methods");var c=a[b];if(!c)return f("No such method "+b+" on object "+a);if(!c.apply)return f("Property "+b+" on object "+a+" is not a method");return a[b].apply(a,d)},apply:function(b,d){if(!a||typeof a.apply!=="function")return f(""+a+" is not a function");return a.apply(b,d)},keys:function(){return y(a)}},
e,function(){return a})}function h(a,b,d){function c(a){try{return b?b(a):a}catch(d){return f(d)}}function e(a){try{return d?d(a):f(a)}catch(b){return f(b)}}var g=o(),h=!1;q(l(a),"when",function(a){h||(h=!0,g.resolve(l(a).promiseSend("when",c,e)))},function(a){h||(h=!0,g.resolve(e(a)))});return g.promise}function i(a){return function(b){var d=Array.prototype.slice.call(arguments,1);return u.apply(e,[b,a].concat(d))}}function u(a,b){var d=o(),c=Array.prototype.slice.call(arguments,2);q.apply(e,[l(a),
b,d.resolve].concat(c));return d.promise}function q(a){var b=Array.prototype.slice.call(arguments,1);n(function(){a.promiseSend.apply(a,b)})}var n;try{n=m("event-queue").enqueue}catch(B){n=function(a){setTimeout(a,0)}}var s=Object.freeze||j,p=Object.create||function(a){var b=function(){};b.prototype=a;return new b},y=Object.keys||function(a){var b=[],d;for(d in a)b.push(d);return b},v=Array.prototype.reduce||function(a,b){for(var d=0,c=this.length;d<c;d++)b=a(b,this[d],d);return b},x=typeof console===
"undefined"?j:function(a){console.log(a)};c.enqueue=n;c.defer=o;c.makePromise=g;g.prototype.then=function(a,b){return h(this,a,b)};v.call(["get","put","del","post","invoke","keys","apply","call","wait","join","report","end"],function(a,b){g.prototype[b]=function(){return c[b].apply(c,[this].concat(Array.prototype.slice.call(arguments)))}},e);g.prototype.toSource=function(){return this.toString()};g.prototype.toString=function(){return"[object Promise]"};s(g.prototype);c.isPromise=r;c.isResolved=function(a){return!r(k(a.valueOf()))};
c.isFulfilled=w;c.isRejected=t;c.reject=f;f.prototype=p(g.prototype,{constructor:{value:f}});c.ref=l;c.def=function(a){return g({isDef:function(){}},function(){var b=Array.prototype.slice.call(arguments);return u.apply(e,[a].concat(b))},function(){return a.valueOf()})};c.when=h;c.asap=function(a,b,d){b=b||j;if(w(a))return k(b(k(a)));else if(t(a))if(a=a.valueOf().reason,d)return d(a);else throw a;else return h(a,b,d)};var k=function(a){return a===e||a===null?a:a.valueOf()};c.Method=i;c.send=u;c.get=
i("get");c.put=i("put");c.del=i("del");var z=c.post=i("post");c.invoke=function(a,b){var d=Array.prototype.slice.call(arguments,2);return z(a,b,d)};var A=c.apply=i("apply");c.call=function(a,b){var d=Array.prototype.slice.call(arguments,2);return A(a,b,d)};c.keys=i("keys");c.wait=function(a){var b=Array.prototype.slice.call(arguments,1);return v.call(b,function(a,b){return h(b,function(){return a})},a)};c.join=function(){var a=Array.prototype.slice.call(arguments),b=a.pop();return v.call(a,function(b,
c,e){return h(c,function(c){return h(b,function(){a[e]=c})})},e).then(function(){return b.apply(e,a)})};c.report=function(a,b){b?b.message||(b=Error(b||"REPORT")):b=Error("REPORT");return h(a,e,function(a){x(b&&b.stack||b);x(a&&a.stack||a);return f(a)})};c.end=function(a){h(a,e,function(a){n(function(){throw a;})})}});