(function(r){"function"===typeof bootstrap?bootstrap("promise",r):"object"===typeof exports?r(void 0,exports):"function"===typeof define?define(r):"undefined"!==typeof ses?ses.ok()&&(ses.makeQ=function(){return r(void 0,{})}):r(void 0,Q={})})(function(r,c){function J(a,b){b.stack&&("object"===typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf(K))&&(a.stack=L(a.stack)+"\n"+K+"\n"+L(b.stack))}function L(a){for(var a=a.split("\n"),b=[],d=0;d<a.length;++d){var f=a[d],c;if(c=/at .+ \((.*):(\d+):\d+\)/.exec(f)){var h=
c[2];c=c[1]===M&&h>=aa&&h<=ba}else c=!1;!c&&!(-1!==f.indexOf("(module.js:")||-1!==f.indexOf("(node.js:"))&&b.push(f)}return b.join("\n")}function N(){if(Error.captureStackTrace){var a,b,d=Error.prepareStackTrace;Error.prepareStackTrace=function(d,c){a=c[1].getFileName();b=c[1].getLineNumber()};Error().stack;Error.prepareStackTrace=d;M=a;return b}}function o(a,b,d){return function(){"undefined"!==typeof console&&"function"===typeof console.warn&&console.warn(b+" is deprecated, use "+d+" instead.",
Error("").stack);return a.apply(a,arguments)}}function k(){function a(a){b&&(c=p(a),u(b,function(a,b){l(function(){c.promiseDispatch.apply(c,b)})},void 0),d=b=void 0)}var b=[],d=[],c,i=A(k.prototype),h=A(j.prototype);h.promiseDispatch=function(a,i,h){var x=e(arguments);b?(b.push(x),"when"===i&&h[1]&&d.push(h[1])):l(function(){c.promiseDispatch.apply(c,x)})};h.valueOf=function(){return b?h:c.valueOf()};Error.captureStackTrace&&(Error.captureStackTrace(h,k),h.stack=h.stack.substring(h.stack.indexOf("\n")+
1));y(h);i.promise=h;i.resolve=a;i.reject=function(b){a(m(b))};i.notify=function(a){b&&u(d,function(b,d){l(function(){d(a)})},void 0)};return i}function j(a,b,d,c){void 0===b&&(b=function(a){return m(Error("Promise does not support operation: "+a))});var i=A(j.prototype);i.promiseDispatch=function(d,c,f){var e;try{e=a[c]?a[c].apply(i,f):b.call(i,c,f)}catch(x){e=m(x)}d&&d(e)};d&&(i.valueOf=d);c&&(i.exception=c);y(i);return i}function s(a){return v(a)?a.valueOf():a}function v(a){return a&&"function"===
typeof a.promiseDispatch}function B(a){return!v(s(a))}function O(a){a=s(a);return v(a)&&"exception"in a}function m(a){var a=a||Error(),b=j({when:function(b){if(b){var c=ca(C,this);-1!==c&&(D.splice(c,1),C.splice(c,1))}return b?b(a):m(a)}},function(){return m(a)},function(){return this},a);!P&&("undefined"!==typeof window&&!window.Touch&&window.console)&&console.log("Should be empty:",D);P=!0;C.push(b);D.push(a);return b}function p(a){if(v(a))return a;if((a=s(a))&&"function"===typeof a.then){var b=
k();a.then(b.resolve,b.reject,b.notify);return b.promise}return j({when:function(){return a},get:function(b){return a[b]},put:function(b,c){a[b]=c;return a},del:function(b){delete a[b];return a},post:function(b,c){return a[b].apply(a,c)},apply:function(b){return a.apply(void 0,b)},keys:function(){return da(a)}},void 0,function(){return a})}function g(a,b,d,c){function i(a){try{return b?b(a):a}catch(d){return m(d)}}function h(a){if(d){J(a,j);try{return d(a)}catch(b){return m(b)}}return m(a)}var e=
k(),g=!1,j=p(a);l(function(){j.promiseDispatch(function(a){g||(g=!0,e.resolve(i(a)))},"when",[function(a){g||(g=!0,e.resolve(h(a)))}])});j.promiseDispatch(void 0,"when",[void 0,function(a){e.notify(c?c(a):a)}]);return e.promise}function R(a,b,d){return g(a,function(a){return z(a).then(function(a){return b.apply(void 0,a)},d)},d)}function E(a,b,d){var c=k();l(function(){p(a).promiseDispatch(c.resolve,b,d)});return c.promise}function q(a){return function(b){var d=e(arguments,1);return E(b,a,d)}}function F(a){var b=
e(arguments,1);return t(a,b)}function z(a){return g(a,function(a){var d=a.length;if(0===d)return p(a);var c=k();u(a,function(i,h,e){B(h)?(a[e]=s(h),0===--d&&c.resolve(a)):g(h,function(i){a[e]=i;0===--d&&c.resolve(a)}).fail(c.reject)},void 0);return c.promise})}function S(a,b){return g(a,void 0,b)}function T(a,b,d,f){b=b||d||f?g(a,b,d,f):a;S(b,function(b){l(function(){J(b,a);if(c.onerror)c.onerror(b);else throw b;})})}function U(a,b,d){return V(a,b).apply(void 0,d)}function V(a){if(1<arguments.length)var b=
arguments[1],d=e(arguments,2),c=a,a=function(){var a=d.concat(e(arguments));return c.apply(b,a)};return function(){var b=k(),d=e(arguments);d.push(b.makeNodeResolver());t(a,d).fail(b.reject);return b.promise}}function W(a,b){var d=e(arguments,2),c=k();d.push(c.makeNodeResolver());G(a,b,d).fail(c.reject);return c.promise}function X(a,b){if(b)a.then(function(a){l(function(){b(null,a)})},function(a){l(function(){b(a)})});else return a}var aa=N(),M,H=function(){},y=Object.freeze||H;"undefined"!==typeof cajaVM&&
(y=cajaVM.def);var l;if("undefined"!==typeof process)l=process.nextTick;else if("function"===typeof setImmediate)l=setImmediate;else if("undefined"!==typeof MessageChannel){var Y=new MessageChannel,w={},Z=w;Y.port1.onmessage=function(){w=w.next;var a=w.task;delete w.task;a()};l=function(a){Z=Z.next={task:a};Y.port2.postMessage(0)}}else l=function(a){setTimeout(a,0)};var n;Function.prototype.bind?(n=Function.prototype.bind,n=n.bind(n.call)):n=function(a){return function(){return a.call.apply(a,arguments)}};
var e=n(Array.prototype.slice),u=n(Array.prototype.reduce||function(a,b){var d=0,c=this.length;if(arguments.length===1){do{if(d in this){b=this[d++];break}if(++d>=c)throw new TypeError;}while(1)}for(;d<c;d++)d in this&&(b=a(b,this[d],d));return b}),ca=n(Array.prototype.indexOf||function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return b;return-1}),$=n(Array.prototype.map||function(a,b){var c=this,f=[];u(c,function(e,h,g){f.push(a.call(b,h,g,c))},void 0);return f}),A=Object.create||function(a){function b(){}
b.prototype=a;return new b},da=Object.keys||function(a){var b=[],c;for(c in a)b.push(c);return b},ea=Object.prototype.toString,I;I="undefined"!==typeof ReturnValue?ReturnValue:function(a){this.value=a};var K="From previous event:";c.nextTick=l;c.defer=k;k.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):arguments.length>2?a.resolve(e(arguments,1)):a.resolve(c)}};c.promise=function(a){var b=k();F(a,b.resolve,b.reject,b.notify).fail(b.reject);return b.promise};c.makePromise=
j;j.prototype.then=function(a,b,c){return g(this,a,b,c)};j.prototype.thenResolve=function(a){return g(this,function(){return a})};u("isResolved isFulfilled isRejected dispatch when spread get put del post send invoke keys fapply fcall fbind all allResolved timeout delay catch finally fail fin progress end done nfcall nfapply nfbind ncall napply nbind npost nsend ninvoke nend nodeify".split(" "),function(a,b){j.prototype[b]=function(){return c[b].apply(c,[this].concat(e(arguments)))}},void 0);j.prototype.toSource=
function(){return this.toString()};j.prototype.toString=function(){return"[object Promise]"};y(j.prototype);c.nearer=s;c.isPromise=v;c.isResolved=function(a){return B(a)||O(a)};c.isFulfilled=B;c.isRejected=O;var C=[],D=[],P;c.reject=m;c.begin=p;c.resolve=p;c.master=function(a){return j({isDef:function(){}},function(b,c){return E(a,b,c)},function(){return s(a)})};c.when=g;c.spread=R;c.async=function(a){return function(){function b(a,b){var k;try{k=c[a](b)}catch(j){return ea(j)==="[object StopIteration]"||
j instanceof I?j.value:m(j)}return g(k,e,i)}var c=a.apply(this,arguments),e=b.bind(b,"send"),i=b.bind(b,"throw");return e()}};c["return"]=function(a){throw new I(a);};c.promised=function(a){return function(){return R([this,z(arguments)],function(b,c){return a.apply(b,c)})}};c.dispatch=E;c.dispatcher=q;c.get=q("get");c.put=q("put");c["delete"]=c.del=q("del");var G=c.post=q("post");c.send=function(a,b){var c=e(arguments,2);return G(a,b,c)};c.invoke=o(c.send,"invoke","send");var t=c.fapply=q("apply");
c["try"]=F;c.fcall=F;c.fbind=function(a){var b=e(arguments,1);return function(){var c=b.concat(e(arguments));return t(a,c)}};c.keys=q("keys");c.all=z;c.allResolved=function(a){return g(a,function(a){return g(z($(a,function(a){return g(a,H,H)})),function(){return $(a,p)})})};c["catch"]=c.fail=S;c.progress=function(a,b){return g(a,void 0,void 0,b)};c["finally"]=c.fin=function(a,b){return g(a,function(a){return g(b(),function(){return a})},function(a){return g(b(),function(){return m(a)})})};c.end=o(T,
"end","done");c.done=T;c.timeout=function(a,b){var c=k(),e=setTimeout(function(){c.reject(Error("Timed out after "+b+" ms"))},b);g(a,function(a){clearTimeout(e);c.resolve(a)},function(a){clearTimeout(e);c.reject(a)});return c.promise};c.delay=function(a,b){if(b===void 0){b=a;a=void 0}var c=k();setTimeout(function(){c.resolve(a)},b);return c.promise};c.nfapply=function(a,b){var c=e(b),f=k();c.push(f.makeNodeResolver());t(a,c).fail(f.reject);return f.promise};c.nfcall=function(a){var b=e(arguments,
1),c=k();b.push(c.makeNodeResolver());t(a,b).fail(c.reject);return c.promise};c.nfbind=function(a){var b=e(arguments,1);return function(){var c=b.concat(e(arguments)),f=k();c.push(f.makeNodeResolver());t(a,c).fail(f.reject);return f.promise}};c.napply=o(U,"napply","npost");c.ncall=o(function(a,b){var c=e(arguments,2);return U(a,b,c)},"ncall","ninvoke");c.nbind=o(V,"nbind","nfbind");c.npost=function(a,b,c){var c=e(c),f=k();c.push(f.makeNodeResolver());G(a,b,c).fail(f.reject);return f.promise};c.nsend=
W;c.ninvoke=o(W,"ninvoke","nsend");c.nend=o(X,"nend","nodeify");c.nodeify=X;var ba=N()});
